#include <stdlib.h>
#include <string.h>
#include "formats/img.h"
#include "formats/libattopng.h"

static const uint32_t colors[] = {
        0x00000000, 0x00800000, 0x00008000, 0x00808000, 0x00000080, 0x00800080, 0x00008080, 0x00c0c0c0, 0x00c0dcc0,
        0x00a6caf0, 0x00ffffcc, 0x00ffff99, 0x00ffff66, 0x00ffff33, 0x00ffccff, 0x00ffcccc, 0x00ffcc99, 0x00ffcc66,
        0x00ffcc33, 0x00ffcc00, 0x00ff99ff, 0x00ff99cc, 0x00ff9999, 0x00ff9966, 0x00ff9933, 0x00ff9900, 0x00ff66ff,
        0x00ff66cc, 0x00ff6699, 0x00ff6666, 0x00ff6633, 0x00ff6600, 0x00ff33ff, 0x00ff33cc, 0x00ff3399, 0x00ff3366,
        0x00ff3333, 0x00ff3300, 0x00ff00cc, 0x00ff0099, 0x00ff0066, 0x00ff0033, 0x00ccffff, 0x00ccffcc, 0x00ccff99,
        0x00ccff66, 0x00ccff33, 0x00ccff00, 0x00ccccff, 0x00cccccc, 0x00cccc99, 0x00cccc66, 0x00cccc33, 0x00cccc00,
        0x00cc99ff, 0x00cc99cc, 0x00cc9999, 0x00cc9966, 0x00cc9933, 0x00cc9900, 0x00cc66ff, 0x00cc66cc, 0x00cc6699,
        0x00cc6666, 0x00cc6633, 0x00cc6600, 0x00cc33ff, 0x00cc33cc, 0x00cc3399, 0x00cc3366, 0x00cc3333, 0x00cc3300,
        0x00cc00ff, 0x00cc00cc, 0x00cc0099, 0x00cc0066, 0x00cc0033, 0x00cc0000, 0x0099ffff, 0x0099ffcc, 0x0099ff99,
        0x0099ff66, 0x0099ff33, 0x0099ff00, 0x0099ccff, 0x0099cccc, 0x0099cc99, 0x0099cc66, 0x0099cc33, 0x0099cc00,
        0x009999ff, 0x009999cc, 0x00999999, 0x00999966, 0x00999933, 0x00999900, 0x009966ff, 0x009966cc, 0x00996699,
        0x00996666, 0x00996633, 0x00996600, 0x009933ff, 0x009933cc, 0x00993399, 0x00993366, 0x00993333, 0x00993300,
        0x009900ff, 0x009900cc, 0x00990099, 0x00990066, 0x00990033, 0x00990000, 0x0066ffff, 0x0066ffcc, 0x0066ff99,
        0x0066ff66, 0x0066ff33, 0x0066ff00, 0x0066ccff, 0x0066cccc, 0x0066cc99, 0x0066cc66, 0x0066cc33, 0x0066cc00,
        0x006699ff, 0x006699cc, 0x00669999, 0x00669966, 0x00669933, 0x00669900, 0x006666ff, 0x006666cc, 0x00666699,
        0x00666666, 0x00666633, 0x00666600, 0x006633ff, 0x006633cc, 0x00663399, 0x00663366, 0x00663333, 0x00663300,
        0x006600ff, 0x006600cc, 0x00660099, 0x00660066, 0x00660033, 0x00660000, 0x0033ffff, 0x0033ffcc, 0x0033ff99,
        0x0033ff66, 0x0033ff33, 0x0033ff00, 0x0033ccff, 0x0033cccc, 0x0033cc99, 0x0033cc66, 0x0033cc33, 0x0033cc00,
        0x003399ff, 0x003399cc, 0x00339999, 0x00339966, 0x00339933, 0x00339900, 0x003366ff, 0x003366cc, 0x00336699,
        0x00336666, 0x00336633, 0x00336600, 0x003333ff, 0x003333cc, 0x00333399, 0x00333366, 0x00333333, 0x00333300,
        0x003300ff, 0x003300cc, 0x00330099, 0x00330066, 0x00330033, 0x00330000, 0x0000ffcc, 0x0000ff99, 0x0000ff66,
        0x0000ff33, 0x0000ccff, 0x0000cccc, 0x0000cc99, 0x0000cc66, 0x0000cc33, 0x0000cc00, 0x000099ff, 0x000099cc,
        0x00009999, 0x00009966, 0x00009933, 0x00009900, 0x000066ff, 0x000066cc, 0x00006699, 0x00006666, 0x00006633,
        0x00006600, 0x000033ff, 0x000033cc, 0x00003399, 0x00003366, 0x00003333, 0x00003300, 0x000000cc, 0x00000099,
        0x00000066, 0x00000033, 0x00ee0000, 0x00dd0000, 0x00bb0000, 0x00aa0000, 0x00770000, 0x00440000, 0x0000ee00,
        0x0000dd00, 0x0000bb00, 0x0000aa00, 0x00007700, 0x00004400, 0x000000ee, 0x000000dd, 0x000000bb, 0x000000aa,
        0x00000077, 0x00000044, 0x00eeeeee, 0x00dddddd, 0x00bbbbbb, 0x00aaaaaa, 0x00888888, 0x00777777, 0x00555555,
        0x00444444, 0x00222222, 0x00000001, 0x00fffbf0, 0x00a0a0a4, 0x00808080, 0x00ff0000, 0x0000ff00, 0x00ffff00,
        0x000000ff, 0x00ff00ff, 0x0000ffff, 0x00ffffff
};

static const uint32_t png_palette[] = {
        0x00000000, 0xff000080, 0xff008000, 0xff008080, 0xff800000, 0xff800080, 0xff808000, 0xffc0c0c0, 0xffc0dcc0,
        0xfff0caa6, 0xffccffff, 0xff99ffff, 0xff66ffff, 0xff33ffff, 0xffffccff, 0xffccccff, 0xff99ccff, 0xff66ccff,
        0xff33ccff, 0xff00ccff, 0xffff99ff, 0xffcc99ff, 0xff9999ff, 0xff6699ff, 0xff3399ff, 0xff0099ff, 0xffff66ff,
        0xffcc66ff, 0xff9966ff, 0xff6666ff, 0xff3366ff, 0xff0066ff, 0xffff33ff, 0xffcc33ff, 0xff9933ff, 0xff6633ff,
        0xff3333ff, 0xff0033ff, 0xffcc00ff, 0xff9900ff, 0xff6600ff, 0xff3300ff, 0xffffffcc, 0xffccffcc, 0xff99ffcc,
        0xff66ffcc, 0xff33ffcc, 0xff00ffcc, 0xffffcccc, 0xffcccccc, 0xff99cccc, 0xff66cccc, 0xff33cccc, 0xff00cccc,
        0xffff99cc, 0xffcc99cc, 0xff9999cc, 0xff6699cc, 0xff3399cc, 0xff0099cc, 0xffff66cc, 0xffcc66cc, 0xff9966cc,
        0xff6666cc, 0xff3366cc, 0xff0066cc, 0xffff33cc, 0xffcc33cc, 0xff9933cc, 0xff6633cc, 0xff3333cc, 0xff0033cc,
        0xffff00cc, 0xffcc00cc, 0xff9900cc, 0xff6600cc, 0xff3300cc, 0xff0000cc, 0xffffff99, 0xffccff99, 0xff99ff99,
        0xff66ff99, 0xff33ff99, 0xff00ff99, 0xffffcc99, 0xffcccc99, 0xff99cc99, 0xff66cc99, 0xff33cc99, 0xff00cc99,
        0xffff9999, 0xffcc9999, 0xff999999, 0xff669999, 0xff339999, 0xff009999, 0xffff6699, 0xffcc6699, 0xff996699,
        0xff666699, 0xff336699, 0xff006699, 0xffff3399, 0xffcc3399, 0xff993399, 0xff663399, 0xff333399, 0xff003399,
        0xffff0099, 0xffcc0099, 0xff990099, 0xff660099, 0xff330099, 0xff000099, 0xffffff66, 0xffccff66, 0xff99ff66,
        0xff66ff66, 0xff33ff66, 0xff00ff66, 0xffffcc66, 0xffcccc66, 0xff99cc66, 0xff66cc66, 0xff33cc66, 0xff00cc66,
        0xffff9966, 0xffcc9966, 0xff999966, 0xff669966, 0xff339966, 0xff009966, 0xffff6666, 0xffcc6666, 0xff996666,
        0xff666666, 0xff336666, 0xff006666, 0xffff3366, 0xffcc3366, 0xff993366, 0xff663366, 0xff333366, 0xff003366,
        0xffff0066, 0xffcc0066, 0xff990066, 0xff660066, 0xff330066, 0xff000066, 0xffffff33, 0xffccff33, 0xff99ff33,
        0xff66ff33, 0xff33ff33, 0xff00ff33, 0xffffcc33, 0xffcccc33, 0xff99cc33, 0xff66cc33, 0xff33cc33, 0xff00cc33,
        0xffff9933, 0xffcc9933, 0xff999933, 0xff669933, 0xff339933, 0xff009933, 0xffff6633, 0xffcc6633, 0xff996633,
        0xff666633, 0xff336633, 0xff006633, 0xffff3333, 0xffcc3333, 0xff993333, 0xff663333, 0xff333333, 0xff003333,
        0xffff0033, 0xffcc0033, 0xff990033, 0xff660033, 0xff330033, 0xff000033, 0xffccff00, 0xff99ff00, 0xff66ff00,
        0xff33ff00, 0xffffcc00, 0xffcccc00, 0xff99cc00, 0xff66cc00, 0xff33cc00, 0xff00cc00, 0xffff9900, 0xffcc9900,
        0xff999900, 0xff669900, 0xff339900, 0xff009900, 0xffff6600, 0xffcc6600, 0xff996600, 0xff666600, 0xff336600,
        0xff006600, 0xffff3300, 0xffcc3300, 0xff993300, 0xff663300, 0xff333300, 0xff003300, 0xffcc0000, 0xff990000,
        0xff660000, 0xff330000, 0xff0000ee, 0xff0000dd, 0xff0000bb, 0xff0000aa, 0xff000077, 0xff000044, 0xff00ee00,
        0xff00dd00, 0xff00bb00, 0xff00aa00, 0xff007700, 0xff004400, 0xffee0000, 0xffdd0000, 0xffbb0000, 0xffaa0000,
        0xff770000, 0xff440000, 0xffeeeeee, 0xffdddddd, 0xffbbbbbb, 0xffaaaaaa, 0xff888888, 0xff777777, 0xff555555,
        0xff444444, 0xff222222, 0xff010000, 0xfff0fbff, 0xffa4a0a0, 0xff808080, 0xff0000ff, 0xff00ff00, 0xff00ffff,
        0xffff0000, 0xffff00ff, 0xffffff00, 0xffffffff
};

// ---------------------------------------------------------------------------
char *libsrf_raw_to_bmp(uint16_t *data, size_t width, size_t height, size_t *bmp_size) {
    int bpp = 4; // bytes/pixel
    uint32_t line_width = width * bpp;
    size_t x, y;

    if (bpp == 3) {
        line_width = ((uint32_t) ((width * 3 + 3) / 4)) * 4;
    }
    BMPHeader *header = (BMPHeader *) calloc(sizeof(BMPHeader) + line_width * height * bpp, 1);
    if (header == NULL) {
        return NULL;
    }

    char *bmp = (char *) (header + 1);
    memset(bmp, 0xFF, line_width * height * bpp);

    header->header[0] = 'B';
    header->header[1] = 'M';
    header->pos = 54;
    header->header_len = 40;
    header->width = width;
    header->height = height;
    header->layers = 1;
    header->depth = bpp * 8;
    header->data_len = line_width * height * bpp;
    header->filesize = header->data_len + header->pos;

    for (y = 0; y < height; y++) {
        for (x = 0; x < width; x++) {
            int idx = data[x + y * width] & 0xff;
            uint32_t color = colors[idx];
            color |= (~(data[x + y * width] >> 8) << 24);
            int byte_pos = (height - y - 1) * line_width + x * bpp;
            bmp[byte_pos] = color & 0xff;
            bmp[byte_pos + 1] = (color >> 8) & 0xff;
            bmp[byte_pos + 2] = (color >> 16) & 0xff;
            bmp[byte_pos + 3] = (color >> 24) & 0xff;
        }
    }

    *bmp_size = sizeof(BMPHeader) + line_width * height * bpp;
    return (char *) header;
}

// ---------------------------------------------------------------------------
char *libsrf_raw_to_png(uint16_t *data, size_t width, size_t height, size_t *png_size) {
    size_t x, y;
    libattopng_t *png = libattopng_new(width, height, PNG_PALETTE);
    libattopng_set_palette(png, png_palette, 256);

    for (y = 0; y < height; y++) {
        for (x = 0; x < width; x++) {
            int idx = data[x + y * width] & 0xff;
            libattopng_set_pixel(png, x, y, idx);
        }
    }
    char *png_data = libattopng_get_data(png, png_size);
    char *img = (char *) malloc(*png_size);
    memcpy(img, png_data, *png_size);
    libattopng_destroy(png);
    return img;
}