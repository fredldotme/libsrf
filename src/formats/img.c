#include <stdlib.h>
#include <string.h>
#include "formats/img.h"
#include "formats/libattopng.h"

static const uint32_t palette_1[] = {
        0x00000000, 0xff000080, 0xff008000, 0xff008080, 0xff800000, 0xff800080, 0xff808000, 0xffc0c0c0, 0xffc0dcc0,
        0xfff0caa6, 0xffccffff, 0xff99ffff, 0xff66ffff, 0xff33ffff, 0xffffccff, 0xffccccff, 0xff99ccff, 0xff66ccff,
        0xff33ccff, 0xff00ccff, 0xffff99ff, 0xffcc99ff, 0xff9999ff, 0xff6699ff, 0xff3399ff, 0xff0099ff, 0xffff66ff,
        0xffcc66ff, 0xff9966ff, 0xff6666ff, 0xff3366ff, 0xff0066ff, 0xffff33ff, 0xffcc33ff, 0xff9933ff, 0xff6633ff,
        0xff3333ff, 0xff0033ff, 0xffcc00ff, 0xff9900ff, 0xff6600ff, 0xff3300ff, 0xffffffcc, 0xffccffcc, 0xff99ffcc,
        0xff66ffcc, 0xff33ffcc, 0xff00ffcc, 0xffffcccc, 0xffcccccc, 0xff99cccc, 0xff66cccc, 0xff33cccc, 0xff00cccc,
        0xffff99cc, 0xffcc99cc, 0xff9999cc, 0xff6699cc, 0xff3399cc, 0xff0099cc, 0xffff66cc, 0xffcc66cc, 0xff9966cc,
        0xff6666cc, 0xff3366cc, 0xff0066cc, 0xffff33cc, 0xffcc33cc, 0xff9933cc, 0xff6633cc, 0xff3333cc, 0xff0033cc,
        0xffff00cc, 0xffcc00cc, 0xff9900cc, 0xff6600cc, 0xff3300cc, 0xff0000cc, 0xffffff99, 0xffccff99, 0xff99ff99,
        0xff66ff99, 0xff33ff99, 0xff00ff99, 0xffffcc99, 0xffcccc99, 0xff99cc99, 0xff66cc99, 0xff33cc99, 0xff00cc99,
        0xffff9999, 0xffcc9999, 0xff999999, 0xff669999, 0xff339999, 0xff009999, 0xffff6699, 0xffcc6699, 0xff996699,
        0xff666699, 0xff336699, 0xff006699, 0xffff3399, 0xffcc3399, 0xff993399, 0xff663399, 0xff333399, 0xff003399,
        0xffff0099, 0xffcc0099, 0xff990099, 0xff660099, 0xff330099, 0xff000099, 0xffffff66, 0xffccff66, 0xff99ff66,
        0xff66ff66, 0xff33ff66, 0xff00ff66, 0xffffcc66, 0xffcccc66, 0xff99cc66, 0xff66cc66, 0xff33cc66, 0xff00cc66,
        0xffff9966, 0xffcc9966, 0xff999966, 0xff669966, 0xff339966, 0xff009966, 0xffff6666, 0xffcc6666, 0xff996666,
        0xff666666, 0xff336666, 0xff006666, 0xffff3366, 0xffcc3366, 0xff993366, 0xff663366, 0xff333366, 0xff003366,
        0xffff0066, 0xffcc0066, 0xff990066, 0xff660066, 0xff330066, 0xff000066, 0xffffff33, 0xffccff33, 0xff99ff33,
        0xff66ff33, 0xff33ff33, 0xff00ff33, 0xffffcc33, 0xffcccc33, 0xff99cc33, 0xff66cc33, 0xff33cc33, 0xff00cc33,
        0xffff9933, 0xffcc9933, 0xff999933, 0xff669933, 0xff339933, 0xff009933, 0xffff6633, 0xffcc6633, 0xff996633,
        0xff666633, 0xff336633, 0xff006633, 0xffff3333, 0xffcc3333, 0xff993333, 0xff663333, 0xff333333, 0xff003333,
        0xffff0033, 0xffcc0033, 0xff990033, 0xff660033, 0xff330033, 0xff000033, 0xffccff00, 0xff99ff00, 0xff66ff00,
        0xff33ff00, 0xffffcc00, 0xffcccc00, 0xff99cc00, 0xff66cc00, 0xff33cc00, 0xff00cc00, 0xffff9900, 0xffcc9900,
        0xff999900, 0xff669900, 0xff339900, 0xff009900, 0xffff6600, 0xffcc6600, 0xff996600, 0xff666600, 0xff336600,
        0xff006600, 0xffff3300, 0xffcc3300, 0xff993300, 0xff663300, 0xff333300, 0xff003300, 0xffcc0000, 0xff990000,
        0xff660000, 0xff330000, 0xff0000ee, 0xff0000dd, 0xff0000bb, 0xff0000aa, 0xff000077, 0xff000044, 0xff00ee00,
        0xff00dd00, 0xff00bb00, 0xff00aa00, 0xff007700, 0xff004400, 0xffee0000, 0xffdd0000, 0xffbb0000, 0xffaa0000,
        0xff770000, 0xff440000, 0xffeeeeee, 0xffdddddd, 0xffbbbbbb, 0xffaaaaaa, 0xff888888, 0xff777777, 0xff555555,
        0xff444444, 0xff222222, 0xff010000, 0xfff0fbff, 0xffa4a0a0, 0xff808080, 0xff0000ff, 0xff00ff00, 0xff00ffff,
        0xffff0000, 0xffff00ff, 0xffffff00, 0xffffffff
};

static const uint32_t palette_2[] = {
        0x00000000, 0xff000080, 0xff008000, 0xff008080, 0xff800000, 0xff800080, 0xff808000, 0xffc0c0c0, 0xffc0dcc0,
        0xfff0caa6, 0xffccffff, 0xff99ffff, 0xff66ffff, 0xff33ffff, 0xffffccff, 0xffccccff, 0xff99ccff, 0xff66ccff,
        0xff33ccff, 0xff00ccff, 0xffff99ff, 0xffcc99ff, 0xff9999ff, 0xff6699ff, 0xff3399ff, 0xff0099ff, 0xffff66ff,
        0xffcc66ff, 0xff9966ff, 0xff6666ff, 0xff3366ff, 0xff0066ff, 0xffff33ff, 0xffcc33ff, 0xff9933ff, 0xff6633ff,
        0xff3333ff, 0xff0033ff, 0xffcc00ff, 0xff9900ff, 0xff6600ff, 0xff3300ff, 0xffffffcc, 0xffccffcc, 0xff99ffcc,
        0xff66ffcc, 0xff33ffcc, 0xff00ffcc, 0xffffcccc, 0xffcccccc, 0xff99cccc, 0xff66cccc, 0xff33cccc, 0xff00cccc,
        0xffff99cc, 0xffcc99cc, 0xff9999cc, 0xff6699cc, 0xff3399cc, 0xff0099cc, 0xffff66cc, 0xffcc66cc, 0xff9966cc,
        0xff6666cc, 0xff3366cc, 0xff0066cc, 0xffff33cc, 0xffcc33cc, 0xff9933cc, 0xff6633cc, 0xff3333cc, 0xff0033cc,
        0xffff00cc, 0xffcc00cc, 0xff9900cc, 0xff6600cc, 0xff3300cc, 0xff0000cc, 0xffffff99, 0xffccff99, 0xff99ff99,
        0xff66ff99, 0xff33ff99, 0xff00ff99, 0xffffcc99, 0xffcccc99, 0xff99cc99, 0xff66cc99, 0xff33cc99, 0xff00cc99,
        0xffff9999, 0xffcc9999, 0xff999999, 0xff669999, 0xff339999, 0xff009999, 0xffff6699, 0xffcc6699, 0xff996699,
        0xff666699, 0xff336699, 0xff006699, 0xffff3399, 0xffcc3399, 0xff993399, 0xff663399, 0xff333399, 0xff003399,
        0xffff0099, 0xffcc0099, 0xff990099, 0xff660099, 0xff330099, 0xff000099, 0xffffff66, 0xffccff66, 0xff99ff66,
        0xff66ff66, 0xff33ff66, 0xff00ff66, 0xffffcc66, 0xffcccc66, 0xff99cc66, 0xff66cc66, 0xff33cc66, 0xff00cc66,
        0xffff9966, 0xffcc9966, 0xff999966, 0xff669966, 0xff339966, 0xff009966, 0xffff6666, 0xffcc6666, 0xff996666,
        0xff666666, 0xff336666, 0xff006666, 0xffff3366, 0xffcc3366, 0xff993366, 0xff663366, 0xff333366, 0xff003366,
        0xffff0066, 0xffcc0066, 0xff990066, 0xff660066, 0xff330066, 0xff000066, 0xffffff33, 0xffccff33, 0xff99ff33,
        0xff66ff33, 0xff33ff33, 0xff00ff33, 0xffffcc33, 0xffcccc33, 0xff99cc33, 0xff66cc33, 0xff33cc33, 0xff00cc33,
        0xffff9933, 0xffcc9933, 0xff999933, 0xff669933, 0xff339933, 0xff009933, 0xffff6633, 0xffcc6633, 0xff996633,
        0xff666633, 0xff336633, 0xff006633, 0xffff3333, 0xffcc3333, 0xff993333, 0xff663333, 0xff333333, 0xff003333,
        0xffff0033, 0xffcc0033, 0xff990033, 0xff660033, 0xff330033, 0xff000033, 0xffccff00, 0xff99ff00, 0xff66ff00,
        0xff33ff00, 0xffffcc00, 0xffcccc00, 0xff99cc00, 0xff66cc00, 0xff33cc00, 0xff00cc00, 0xffff9900, 0xffcc9900,
        0xff999900, 0xff669900, 0xff339900, 0xff009900, 0xffff6600, 0xffcc6600, 0xff996600, 0xff666600, 0xff336600,
        0xff006600, 0xffff3300, 0xffcc3300, 0xff993300, 0xff663300, 0xff333300, 0xff003300, 0xffcc0000, 0xff990000,
        0xff660000, 0xff330000, 0xff0000ee, 0xff0000dd, 0xff0000bb, 0xff0000aa, 0xff000077, 0xff000044, 0xff00ee00,
        0xff00dd00, 0xff00bb00, 0xff00aa00, 0xff007700, 0xff004400, 0xffee0000, 0xffdd0000, 0xffbb0000, 0xffaa0000,
        0xff770000, 0xff440000, 0xffeeeeee, 0xffdddddd, 0xffbbbbbb, 0xffaaaaaa, 0xff888888, 0xff777777, 0xff555555,
        0xff444444, 0xff222222, 0xff010000, 0xfff0fbff, 0xffa4a0a0, 0xff808080, 0xff0000ff, 0xff00ff00, 0xff00ffff,
        0xffff0000, 0xffff00ff, 0xffffff00, 0xffffffff
};

static const uint32_t palette_3[] = {
        0x00000000, 0xff000080, 0xff008000, 0xff008080, 0xff800000, 0xff800080, 0xff808000, 0xffc0c0c0, 0xffc0dcc0,
        0xfff0caa6, 0xffffffff, 0xff0a0140, 0xff221f33, 0xff100067, 0xff2900ff, 0xff180094, 0xff130071, 0xff18008c,
        0xff2100bd, 0xff3a364d, 0xff2900e7, 0xff2300c6, 0xff2100b5, 0xff2900de, 0xff180081, 0xff2900d6, 0xff2100ad,
        0xff200495, 0xff3100f9, 0xff2900ce, 0xff2100a5, 0xff3208da, 0xff2900c6, 0xff3f0ff7, 0xff3100e8, 0xff5120fe,
        0xff0f013f, 0xff7645f8, 0xff0b0222, 0xffa873fa, 0xffcdc9d1, 0xfffeb3fe, 0xffff8bfd, 0xffff60ed, 0xff31002a,
        0xff3d0034, 0xff31202e, 0xff26001f, 0xff94217b, 0xffbd299c, 0xfffb57d5, 0xffb52994, 0xffde31b5, 0xfff43ec8,
        0xfffd4ad2, 0xff76185f, 0xff99307f, 0xffa52184, 0xffd631ad, 0xffad298c, 0xff783c69, 0xff84216b, 0xffe052bc,
        0xff8c2170, 0xffce31a5, 0xffa32d84, 0xffc6299c, 0xff9c217b, 0xffd631aa, 0xffed3abd, 0xffe239b5, 0xff611b4e,
        0xffbd2994, 0xffe739b7, 0xffde31ad, 0xffc6329c, 0xff942173, 0xffb5298c, 0xffd631a5, 0xfff877d1, 0xff8c216b,
        0xffad2984, 0xff8c868a, 0xffff00a6, 0xffce0084, 0xff60003d, 0xfff7009c, 0xffe60091, 0xffc6007d, 0xff8f005a,
        0xffad006c, 0xffa50067, 0xff9a0060, 0xff7d004e, 0xff500032, 0xffb90073, 0xffd10081, 0xffd60084, 0xff870052,
        0xff720045, 0xff550033, 0xff46002a, 0xff8e848a, 0xff35001f, 0xffff0c9a, 0xff802d5b, 0xffd5147d, 0xff681842,
        0xffd23384, 0xffff3399, 0xff622d47, 0xffc66b95, 0xffb7b1b3, 0xffaa9b9c, 0xfff58785, 0xff461b16, 0xff8c3921,
        0xff662a18, 0xffd65a31, 0xffac4928, 0xff777473, 0xffe76336, 0xffde6339, 0xffb54d29, 0xffc65229, 0xffdd5f33,
        0xffce5a31, 0xfff97344, 0xff9f4221, 0xff783219, 0xffc0522b, 0xffee6a3a, 0xff84391d, 0xfffb7d4d, 0xffbd5229,
        0xff984221, 0xff944221, 0xffde6331, 0xffa54b23, 0xffff905e, 0xffc3c1c0, 0xfffe9d6c, 0xfffeba88, 0xfffee0af,
        0xffdfdedb, 0xfffff8c8, 0xffccc030, 0xffdeded6, 0xff00c000, 0xff00a500, 0xff009c00, 0xff009700, 0xff009400,
        0xff008c00, 0xff008400, 0xff007b00, 0xff007300, 0xff006b00, 0xff006300, 0xff003f00, 0xff03b303, 0xff05aa05,
        0xff10c610, 0xff25ce25, 0xff42fc42, 0xff4bed4b, 0xff399139, 0xff68ff68, 0xff88fb88, 0xff7b937b, 0xff949594,
        0xff2de32e, 0xff005e01, 0xff1e3a25, 0xff9c9f9d, 0xff0cbb51, 0xffa3aea9, 0xff05ea99, 0xff00ffa5, 0xff004a38,
        0xff1e6657, 0xff00ffce, 0xff008074, 0xff2faea9, 0xff053e3d, 0xff62ffff, 0xffb3ffff, 0xff31f9ff, 0xff001718,
        0xff005d69, 0xff85dae5, 0xff00a3bb, 0xff09ddfd, 0xff0094ad, 0xff00bdde, 0xff1cddff, 0xff00c6ea, 0xff00b5d6,
        0xff00adce, 0xff007b93, 0xff00a5c6, 0xff009cbc, 0xff008ca9, 0xff00819c, 0xff0093b2, 0xff256573, 0xff09cbf6,
        0xff02b8e2, 0xff00738e, 0xff00667e, 0xff08c6f3, 0xff009dc3, 0xff0093b8, 0xff0084a7, 0xff00252f, 0xff687275,
        0xff0099ff, 0xff0e4062, 0xff474d52, 0xff637a97, 0xff0066ff, 0xff000061, 0xff00002d, 0xffffffff, 0xffefefef,
        0xffeeeeee, 0xffe7e7e7, 0xffdddddd, 0xffbbbbbb, 0xffadadad, 0xffaaaaaa, 0xff888888, 0xff848484, 0xff777777,
        0xff6b6b6b, 0xff636363, 0xff5a5a5a, 0xff555555, 0xff525252, 0xff4a4a4a, 0xff444444, 0xff424242, 0xff343434,
        0xff313131, 0xff2980ff, 0xff010000, 0xfff0fbff, 0xffa4a0a0, 0xff808080, 0xff0000ff, 0xff00ff00, 0xff00ffff,
        0xffff0000, 0xffff00ff, 0xffffff00, 0xffffffff
};

static const uint32_t *palette[] = {
        palette_1, palette_2, palette_3
};

// ---------------------------------------------------------------------------
char *libsrf_raw_to_bmp(uint16_t *data, size_t width, size_t height, size_t *bmp_size, int palette_idx) {
    int bpp = 4; // bytes/pixel
    uint32_t line_width = width * bpp;
    size_t x, y;

    if (bpp == 3) {
        line_width = ((uint32_t) ((width * 3 + 3) / 4)) * 4;
    }
    BMPHeader *header = (BMPHeader *) calloc(sizeof(BMPHeader) + line_width * height * bpp, 1);
    if (header == NULL) {
        return NULL;
    }

    char *bmp = (char *) (header + 1);
    memset(bmp, 0xFF, line_width * height * bpp);

    header->header[0] = 'B';
    header->header[1] = 'M';
    header->pos = 54;
    header->header_len = 40;
    header->width = width;
    header->height = height;
    header->layers = 1;
    header->depth = bpp * 8;
    header->data_len = line_width * height * bpp;
    header->filesize = header->data_len + header->pos;

    uint32_t *p = palette[palette_idx];

    for (y = 0; y < height; y++) {
        for (x = 0; x < width; x++) {
            int idx = data[x + y * width] & 0xff;
            uint32_t color = ((p[idx] & 0xff) << 16) | (p[idx] & 0xff00) |
                             ((p[idx] >> 16) & 0xff);
            color |= (~(data[x + y * width] >> 8) << 24);
            int byte_pos = (height - y - 1) * line_width + x * bpp;
            bmp[byte_pos] = color & 0xff;
            bmp[byte_pos + 1] = (color >> 8) & 0xff;
            bmp[byte_pos + 2] = (color >> 16) & 0xff;
            bmp[byte_pos + 3] = (color >> 24) & 0xff;
        }
    }

    *bmp_size = sizeof(BMPHeader) + line_width * height * bpp;
    return (char *) header;
}

// ---------------------------------------------------------------------------
char *libsrf_raw_to_png(uint16_t *data, size_t width, size_t height, size_t *png_size, int palette_idx) {
    size_t x, y;
    libattopng_t *png = libattopng_new(width, height, PNG_PALETTE);
    libattopng_set_palette(png, (uint32_t *) palette[palette_idx], 256);

    for (y = 0; y < height; y++) {
        for (x = 0; x < width; x++) {
            int idx = data[x + y * width] & 0xff;
            libattopng_set_pixel(png, x, y, idx);
        }
    }
    char *png_data = libattopng_get_data(png, png_size);
    char *img = (char *) malloc(*png_size);
    memcpy(img, png_data, *png_size);
    libattopng_destroy(png);
    return img;
}