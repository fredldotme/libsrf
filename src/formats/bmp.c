#include <stdlib.h>
#include "formats/bmp.h"

static const unsigned char *colors =
        "\0\0\0\200\0\0\0\200\0\200\200\0\0\0\200\200\0\200\0\200\200\300\300\300"
        "\300\334\300\246\312\360\377\377\314\377\377\231\377\377f\377\3773\377\314"
        "\377\377\314\314\377\314\231\377\314f\377\3143\377\314\0\377\231\377\377"
        "\231\314\377\231\231\377\231f\377\2313\377\231\0\377f\377\377f\314\377f\231"
        "\377ff\377f3\377f\0\3773\377\3773\314\3773\231\3773f\37733\3773\0\377\0\314"
        "\377\0\231\377\0f\377\0""3\314\377\377\314\377\314\314\377\231\314\377f\314"
        "\3773\314\377\0\314\314\377\314\314\314\314\314\231\314\314f\314\3143\314"
        "\314\0\314\231\377\314\231\314\314\231\231\314\231f\314\2313\314\231\0\314"
        "f\377\314f\314\314f\231\314ff\314f3\314f\0\3143\377\3143\314\3143\231\314"
        "3f\31433\3143\0\314\0\377\314\0\314\314\0\231\314\0f\314\0""3\314\0\0\231"
        "\377\377\231\377\314\231\377\231\231\377f\231\3773\231\377\0\231\314\377"
        "\231\314\314\231\314\231\231\314f\231\3143\231\314\0\231\231\377\231\231"
        "\314\231\231\231\231\231f\231\2313\231\231\0\231f\377\231f\314\231f\231\231"
        "ff\231f3\231f\0\2313\377\2313\314\2313\231\2313f\23133\2313\0\231\0\377\231"
        "\0\314\231\0\231\231\0f\231\0""3\231\0\0f\377\377f\377\314f\377\231f\377"
        "ff\3773f\377\0f\314\377f\314\314f\314\231f\314ff\3143f\314\0f\231\377f\231"
        "\314f\231\231f\231ff\2313f\231\0ff\377ff\314ff\231fffff3ff\0f3\377f3\314"
        "f3\231f3ff33f3\0f\0\377f\0\314f\0\231f\0ff\0""3f\0\0""3\377\3773\377\314"
        "3\377\2313\377f3\37733\377\0""3\314\3773\314\3143\314\2313\314f3\31433\314"
        "\0""3\231\3773\231\3143\231\2313\231f3\23133\231\0""3f\3773f\3143f\2313f"
        "f3f33f\0""33\37733\31433\23133f33333\0""3\0\3773\0\3143\0\2313\0f3\0""33"
        "\0\0\0\377\314\0\377\231\0\377f\0\3773\0\314\377\0\314\314\0\314\231\0\314"
        "f\0\3143\0\314\0\0\231\377\0\231\314\0\231\231\0\231f\0\2313\0\231\0\0f\377"
        "\0f\314\0f\231\0ff\0f3\0f\0\0""3\377\0""3\314\0""3\231\0""3f\0""33\0""3\0"
        "\0\0\314\0\0\231\0\0f\0\0""3\356\0\0\335\0\0\273\0\0\252\0\0w\0\0D\0\0\0"
        "\356\0\0\335\0\0\273\0\0\252\0\0w\0\0D\0\0\0\356\0\0\335\0\0\273\0\0\252"
        "\0\0w\0\0D\356\356\356\335\335\335\273\273\273\252\252\252\210\210\210ww"
        "wUUUDDD\"\"\"\0\0\1\377\373\360\240\240\244\200\200\200\377\0\0\0\377\0\377"
        "\377\0\0\0\377\377\0\377\0\377\377\377\377\377";

char *libsrf_raw_to_bmp(uint16_t *data, size_t width, size_t height, size_t *bmp_size) {
    int bpp = 4; // bytes/pixel
    uint32_t line_width = width * bpp;
    size_t x, y;

    if (bpp == 3) {
        line_width = ((uint32_t) ((width * 3 + 3) / 4)) * 4;
    }
    BMPHeader *header = (BMPHeader *) calloc(sizeof(BMPHeader) + line_width * height * bpp, 1);
    if (header == NULL) {
        return NULL;
    }

    char *bmp = (char *) (header + 1);
    memset(bmp, 0xFF, line_width * height * bpp);

    header->header[0] = 'B';
    header->header[1] = 'M';
    header->pos = 54;
    header->header_len = 40;
    header->width = width;
    header->height = height;
    header->layers = 1;
    header->depth = bpp * 8;
    header->data_len = line_width * height * bpp;
    header->filesize = header->data_len + header->pos;

    for (y = 0; y < height; y++) {
        for (x = 0; x < width; x++) {
            int idx = data[x + y * width] & 0xff;
            uint32_t color = colors[idx * 3 + 2] | (colors[idx * 3 + 1] << 8) | (colors[idx * 3] << 16);
            color |= (~(data[x + y * width] >> 8) << 24);
            int byte_pos = (height - y - 1) * line_width + x * bpp;
            bmp[byte_pos] = color & 0xff;
            bmp[byte_pos + 1] = (color >> 8) & 0xff;
            bmp[byte_pos + 2] = (color >> 16) & 0xff;
            bmp[byte_pos + 3] = (color >> 24) & 0xff;
        }
    }

    *bmp_size = sizeof(BMPHeader) + line_width * height * bpp;
    return (char *) header;
}